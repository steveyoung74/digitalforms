<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Profile | Evelyn Partners Fact Find</title>
    <style>
        :root {
            /* Primary Brand Colours - Evelyn Partners Rebrand */
            --primary: #2D2047;
            --primary-dark: #1E1530;
            --primary-light: #6B3FA0;
            
            /* Secondary Accent Colours */
            --accent-teal: #34675C;
            --accent-coral: #E07065;
            --accent-blue: #5299E0;
            --accent-gold: #C4A35A;
            
            /* Semantic Colours */
            --success: #28a745;
            --success-light: #d4edda;
            --warning: #ffc107;
            --danger: #dc3545;
            
            /* Neutral Grays */
            --gray-50: #f8f9fa;
            --gray-100: #f0f1f3;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            
            /* UI Properties */
            --border-radius: 8px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --transition: all 0.2s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo { font-size: 20px; font-weight: 600; }

        .type-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .header-main { padding: 20px 24px; }
        .journey-title { font-size: 14px; opacity: 0.9; margin-bottom: 4px; }
        .section-title { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
        .section-description { font-size: 14px; opacity: 0.85; }

        .progress-container {
            background: rgba(0,0,0,0.2);
            padding: 16px 24px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            opacity: 0.7;
            cursor: pointer;
            transition: var(--transition);
        }

        .progress-step:hover, .progress-step.active, .progress-step.completed { opacity: 1; }

        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            margin-bottom: 4px;
            transition: var(--transition);
        }

        .progress-step.active .step-dot {
            background: white;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }

        .progress-step.completed .step-dot { background: var(--success); }

        .main-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 24px;
        }

        .save-status-bar {
            background: white;
            border-radius: var(--border-radius);
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .save-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--gray-600);
        }

        .save-status-icon {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray-400);
        }

        .save-status-icon.saved { background: var(--success); }
        .save-status-icon.saving { background: var(--warning); animation: pulse 1s infinite; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .btn-save {
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-save:hover { background: var(--gray-200); }

        .section-card {
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .section-header {
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid transparent;
        }

        .section-card.expanded .section-header { border-bottom-color: var(--gray-200); }
        .section-header:hover { background: var(--gray-50); }

        .section-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .section-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--gray-600);
        }

        .section-card.completed .section-number { background: var(--success-light); color: var(--success); }
        .section-card.active .section-number { background: var(--primary); color: white; }

        .section-info h3 { font-size: 16px; font-weight: 600; color: var(--gray-800); margin-bottom: 2px; }
        .section-info p { font-size: 13px; color: var(--gray-500); }

        .status-badge {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-badge.pending { background: var(--gray-100); color: var(--gray-600); }
        .status-badge.completed { background: var(--success-light); color: var(--success); }

        .toggle-icon {
            font-size: 20px;
            color: var(--gray-400);
            transition: transform 0.2s ease;
        }

        .section-card.expanded .toggle-icon { transform: rotate(180deg); }

        .section-content {
            display: none;
            padding: 24px;
            background: var(--gray-50);
        }

        .section-card.expanded .section-content { display: block; }

        .applicant-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            padding: 4px;
            background: var(--gray-100);
            border-radius: 8px;
            width: fit-content;
        }

        .applicant-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: var(--transition);
        }

        .applicant-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .applicant-form { display: none; }
        .applicant-form.active { display: block; }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group.full-width { grid-column: 1 / -1; }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        .form-label .required { color: var(--danger); }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 15px;
            color: var(--gray-800);
            background: white;
            transition: var(--transition);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(45, 32, 71, 0.15);
        }

        .form-textarea { min-height: 100px; resize: vertical; }
        .form-hint { font-size: 12px; color: var(--gray-500); margin-top: 4px; }

        .option-group { display: flex; flex-wrap: wrap; gap: 12px; }

        .option-item { position: relative; }
        .option-item input { position: absolute; opacity: 0; }

        .option-item label {
            display: block;
            padding: 12px 20px;
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        .option-item input:checked + label {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .option-item label:hover { border-color: var(--primary); }

        .conditional-section {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px dashed var(--gray-300);
        }

        .conditional-section.visible { display: block; }

        .section-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover { background: var(--gray-50); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #218838; }

        .page-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding: 24px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            text-decoration: none;
        }

        .nav-btn-prev { background: var(--gray-100); color: var(--gray-700); }
        .nav-btn-prev:hover { background: var(--gray-200); }
        .nav-btn-next { background: var(--primary); color: white; }
        .nav-btn-next:hover { background: var(--primary-dark); }
        .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .info-box {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .info-box p { font-size: 14px; color: #004085; }

        .wealth-source-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .wealth-source-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .wealth-source-title { font-weight: 600; color: var(--gray-800); }

        .btn-remove {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 14px;
        }

        .btn-add-source {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--gray-50);
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            color: var(--gray-600);
            cursor: pointer;
            width: 100%;
            justify-content: center;
            transition: var(--transition);
        }

        .btn-add-source:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .currency-input {
            position: relative;
        }

        .currency-input::before {
            content: attr(data-currency);
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-500);
            z-index: 1;
        }

        .currency-input input {
            padding-left: 28px;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .header { transition: transform 0.3s ease; }
            .header.header-hidden { transform: translateY(-100%); }
            .header-top { flex-direction: row; padding: 10px 16px; gap: 8px; }
            .logo { font-size: 16px; }
            .type-badge { padding: 4px 10px; font-size: 11px; }
            .header-main { padding: 12px 16px; }
            .journey-title { font-size: 12px; margin-bottom: 2px; }
            .section-title { font-size: 18px; margin-bottom: 4px; }
            .section-description { font-size: 12px; display: none; }
            .progress-container { padding: 10px 16px; }
            .progress-label { font-size: 11px; margin-bottom: 6px; }
            .progress-bar { height: 4px; }
            .progress-steps { margin-top: 8px; }
            .progress-step { font-size: 0; }
            .step-dot { width: 8px; height: 8px; margin-bottom: 0; }
            .progress-step.active .step-dot { box-shadow: 0 0 0 2px rgba(255,255,255,0.3); }
            .main-content { padding: 12px; }
            .form-row { grid-template-columns: 1fr; }
            .page-navigation { flex-direction: column; gap: 12px; }
            .nav-btn { width: 100%; justify-content: center; }
            .section-card { margin-bottom: 12px; }
            .form-input, .form-select { padding: 10px 12px; font-size: 16px; }
        }

        /* Enhanced Source of Wealth Styles */
        .sow-category-card {
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            background: #fff;
        }
        .sow-category-card.has-risk {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fff 100%);
        }
        .sow-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .sow-category-title {
            font-weight: 600;
            color: var(--gray-700);
            font-size: 15px;
        }
        .sow-risk-badge {
            background: #f59e0b;
            color: #fff;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .sow-questions-container {
            display: grid;
            gap: 16px;
            margin-top: 20px;
        }
        .sow-question-group {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .risk-trigger-section {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }
        .risk-trigger-section h4 {
            color: #92400e;
            font-size: 13px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .risk-trigger-section h4::before {
            content: '‚ö†Ô∏è';
        }
        .multiselect-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        .multiselect-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            background: #fff;
        }
        .multiselect-item:hover {
            border-color: var(--primary);
        }
        .multiselect-item.selected {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }
        .multiselect-item input {
            display: none;
        }
        .always-high-risk-notice {
            background: #fef2f2;
            border: 1px solid #fca5a5;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            color: #991b1b;
            font-size: 13px;
        }
        .always-high-risk-notice::before {
            content: 'üî¥ ';
        }
        .always-low-risk-notice {
            background: #f0fdf4;
            border: 1px solid #86efac;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            color: #166534;
            font-size: 13px;
        }
        .always-low-risk-notice::before {
            content: '‚úÖ ';
        }
    </style>
    <script>
        (function() {
            let lastScrollTop = 0;
            let header = null;
            function initMobileHeader() {
                header = document.querySelector('.header');
                if (!header || window.innerWidth > 768) return;
                window.addEventListener('scroll', function() {
                    if (window.innerWidth > 768) { header.classList.remove('header-hidden'); return; }
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    if (scrollTop > lastScrollTop && scrollTop > 100) { header.classList.add('header-hidden'); }
                    else if (scrollTop < lastScrollTop - 10) { header.classList.remove('header-hidden'); }
                    lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
                }, { passive: true });
                window.addEventListener('resize', function() { if (window.innerWidth > 768) header.classList.remove('header-hidden'); });
            }
            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initMobileHeader);
            else initMobileHeader();
        })();
    </script>
</head>
<body>
    <header class="header">
        <div class="header-top">
            <div class="logo">Evelyn Partners</div>
            <div class="application-type">
                <span class="type-badge" id="applicationTypeBadge">Individual</span>
            </div>
        </div>
        <div class="header-main">
            <div class="journey-title">Fact Find A ‚Ä¢ Section 2 of 6</div>
            <h1 class="section-title">Financial Profile</h1>
            <p class="section-description">Employment, income, and the sources of your wealth and funds</p>
        </div>
        <div class="progress-container">
            <div class="progress-label">
                <span>Section Progress</span>
                <span id="progressPercent">0% Complete</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-steps">
                <div class="progress-step active" data-section="1">
                    <div class="step-dot"></div>
                    <span>Employment</span>
                </div>
                <div class="progress-step" data-section="2">
                    <div class="step-dot"></div>
                    <span>Income</span>
                </div>
                <div class="progress-step" data-section="3">
                    <div class="step-dot"></div>
                    <span>Wealth</span>
                </div>
                <div class="progress-step" data-section="4">
                    <div class="step-dot"></div>
                    <span>Funds</span>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="save-status-bar">
            <div class="save-status">
                <div class="save-status-icon" id="saveStatusIcon"></div>
                <span id="saveStatusText">All changes saved</span>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn-save" onclick="saveProgress()">üíæ Save Progress</button>
                <button class="btn-save" onclick="clearForm()">üóëÔ∏è Clear Form</button>
            </div>
        </div>

        <!-- Section 9: Employment Status -->
        <div class="section-card expanded" data-section="1" id="section1">
            <div class="section-header" onclick="toggleSection(1)">
                <div class="section-header-left">
                    <div class="section-number">9</div>
                    <div class="section-info">
                        <h3>Employment Status</h3>
                        <p>Your current employment situation</p>
                    </div>
                </div>
                <div class="section-status">
                    <span class="status-badge pending" id="status1">Not started</span>
                    <span class="toggle-icon">‚ñº</span>
                </div>
            </div>
            <div class="section-content">
                <div class="applicant-toggle" id="applicantToggle1" style="display: none;">
                    <button class="applicant-btn active" onclick="switchApplicant(1, 1)">Primary Applicant</button>
                    <button class="applicant-btn" onclick="switchApplicant(1, 2)">Joint Applicant</button>
                </div>

                <div class="applicant-form active" id="applicant1Form1">
                    <div class="form-group">
                        <label class="form-label">Employment Status <span class="required">*</span></label>
                        <div class="option-group">
                            <div class="option-item">
                                <input type="radio" name="employmentStatus" id="empEmployed" value="employed" onchange="handleEmploymentChange('employed')">
                                <label for="empEmployed">Employed</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" name="employmentStatus" id="empSelfEmployed" value="self-employed" onchange="handleEmploymentChange('self-employed')">
                                <label for="empSelfEmployed">Self-Employed</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" name="employmentStatus" id="empRetired" value="retired" onchange="handleEmploymentChange('retired')">
                                <label for="empRetired">Retired</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" name="employmentStatus" id="empNotWorking" value="not-working" onchange="handleEmploymentChange('not-working')">
                                <label for="empNotWorking">Not Working</label>
                            </div>
                        </div>
                    </div>

                    <!-- Employed Details -->
                    <div class="conditional-section" id="employedSection">
                        <h4 style="margin-bottom: 16px; color: var(--gray-700);">Employment Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Occupation <span class="required">*</span></label>
                                <input type="text" class="form-input" id="occupation" placeholder="Job title" onchange="handleFieldChange('occupation', this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Industry <span class="required">*</span></label>
                                <select class="form-select" id="industry" onchange="handleFieldChange('industry', this.value)">
                                    <option value="">Select industry</option>
                                    <option value="Financial Services">Financial Services</option>
                                    <option value="Healthcare">Healthcare</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Education">Education</option>
                                    <option value="Legal">Legal</option>
                                    <option value="Construction">Construction</option>
                                    <option value="Retail">Retail</option>
                                    <option value="Manufacturing">Manufacturing</option>
                                    <option value="Public Sector">Public Sector</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Employer Name <span class="required">*</span></label>
                                <input type="text" class="form-input" id="employerName" placeholder="Company name" onchange="handleFieldChange('employerName', this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Position Held Since</label>
                                <input type="date" class="form-input" id="positionSince" onchange="handleFieldChange('positionSince', this.value)">
                            </div>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">Employer Address</label>
                            <textarea class="form-textarea" id="employerAddress" placeholder="Full address including postcode" onchange="handleFieldChange('employerAddress', this.value)"></textarea>
                        </div>
                    </div>

                    <!-- Self-Employed Details -->
                    <div class="conditional-section" id="selfEmployedSection">
                        <h4 style="margin-bottom: 16px; color: var(--gray-700);">Business Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Business Name <span class="required">*</span></label>
                                <input type="text" class="form-input" id="businessName" placeholder="Company/trading name" onchange="handleFieldChange('businessName', this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nature of Business <span class="required">*</span></label>
                                <input type="text" class="form-input" id="businessNature" placeholder="What does the business do?" onchange="handleFieldChange('businessNature', this.value)">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Business Type</label>
                                <select class="form-select" id="businessType" onchange="handleFieldChange('businessType', this.value)">
                                    <option value="">Select type</option>
                                    <option value="Sole Trader">Sole Trader</option>
                                    <option value="Partnership">Partnership</option>
                                    <option value="Limited Company">Limited Company</option>
                                    <option value="LLP">LLP</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Years Trading</label>
                                <input type="number" class="form-input" id="yearsTrading" placeholder="Number of years" min="0" onchange="handleFieldChange('yearsTrading', this.value)">
                            </div>
                        </div>
                    </div>

                    <!-- Retired Details -->
                    <div class="conditional-section" id="retiredSection">
                        <h4 style="margin-bottom: 16px; color: var(--gray-700);">Previous Employment</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Previous Occupation</label>
                                <input type="text" class="form-input" id="prevOccupation" placeholder="Previous job title" onchange="handleFieldChange('prevOccupation', this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Previous Industry</label>
                                <input type="text" class="form-input" id="prevIndustry" placeholder="Industry" onchange="handleFieldChange('prevIndustry', this.value)">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Year of Retirement</label>
                                <input type="number" class="form-input" id="retirementYear" placeholder="YYYY" min="1950" max="2025" onchange="handleFieldChange('retirementYear', this.value)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Joint Applicant Employment -->
                <div class="applicant-form" id="applicant2Form1">
                    <div class="form-group">
                        <label class="form-label">Employment Status <span class="required">*</span></label>
                        <div class="option-group">
                            <div class="option-item">
                                <input type="radio" name="employmentStatus_customer2" id="empEmployed2" value="employed" onchange="handleFieldChange('employmentStatus_customer2', 'employed')">
                                <label for="empEmployed2">Employed</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" name="employmentStatus_customer2" id="empSelfEmployed2" value="self-employed" onchange="handleFieldChange('employmentStatus_customer2', 'self-employed')">
                                <label for="empSelfEmployed2">Self-Employed</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" name="employmentStatus_customer2" id="empRetired2" value="retired" onchange="handleFieldChange('employmentStatus_customer2', 'retired')">
                                <label for="empRetired2">Retired</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" name="employmentStatus_customer2" id="empNotWorking2" value="not-working" onchange="handleFieldChange('employmentStatus_customer2', 'not-working')">
                                <label for="empNotWorking2">Not Working</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-row" style="margin-top: 20px;">
                        <div class="form-group">
                            <label class="form-label">Occupation</label>
                            <input type="text" class="form-input" id="occupation_customer2" placeholder="Job title" onchange="handleFieldChange('occupation_customer2', this.value)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Employer Name</label>
                            <input type="text" class="form-input" id="employerName_customer2" placeholder="Company name" onchange="handleFieldChange('employerName_customer2', this.value)">
                        </div>
                    </div>
                </div>

                <div class="section-actions">
                    <button class="btn btn-primary" onclick="completeSection(1)">Continue ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Section 10: Income Details -->
        <div class="section-card" data-section="2" id="section2">
            <div class="section-header" onclick="toggleSection(2)">
                <div class="section-header-left">
                    <div class="section-number">10</div>
                    <div class="section-info">
                        <h3>Income Details</h3>
                        <p>Your annual income from all sources</p>
                    </div>
                </div>
                <div class="section-status">
                    <span class="status-badge pending" id="status2">Not started</span>
                    <span class="toggle-icon">‚ñº</span>
                </div>
            </div>
            <div class="section-content">
                <div class="applicant-toggle" id="applicantToggle2" style="display: none;">
                    <button class="applicant-btn active" onclick="switchApplicant(2, 1)">Primary Applicant</button>
                    <button class="applicant-btn" onclick="switchApplicant(2, 2)">Joint Applicant</button>
                </div>

                <div class="applicant-form active" id="applicant1Form2">
                    <div class="info-box">
                        <p>‚ÑπÔ∏è Please provide your gross annual income (before tax) from all sources. This helps us assess your financial capacity.</p>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Employment Income <span class="required">*</span></label>
                            <div class="currency-input" data-currency="¬£">
                                <input type="number" class="form-input" id="incomeEmployment" placeholder="0" style="padding-left: 28px;" onchange="handleFieldChange('incomeEmployment', this.value); calculateTotalIncome()">
                            </div>
                            <span class="form-hint">Salary, wages, bonuses</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pension Income</label>
                            <div class="currency-input" data-currency="¬£">
                                <input type="number" class="form-input" id="incomePension" placeholder="0" style="padding-left: 28px;" onchange="handleFieldChange('incomePension', this.value); calculateTotalIncome()">
                            </div>
                            <span class="form-hint">State & private pensions</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Investment Income</label>
                            <div class="currency-input" data-currency="¬£">
                                <input type="number" class="form-input" id="incomeInvestments" placeholder="0" style="padding-left: 28px;" onchange="handleFieldChange('incomeInvestments', this.value); calculateTotalIncome()">
                            </div>
                            <span class="form-hint">Dividends, interest</span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Rental Income</label>
                            <div class="currency-input" data-currency="¬£">
                                <input type="number" class="form-input" id="incomeRental" placeholder="0" style="padding-left: 28px;" onchange="handleFieldChange('incomeRental', this.value); calculateTotalIncome()">
                            </div>
                            <span class="form-hint">Property rental income</span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Other Income</label>
                            <div class="currency-input" data-currency="¬£">
                                <input type="number" class="form-input" id="incomeOther" placeholder="0" style="padding-left: 28px;" onchange="handleFieldChange('incomeOther', this.value); calculateTotalIncome()">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Specify Other Income Source</label>
                            <input type="text" class="form-input" id="incomeOtherSource" placeholder="e.g. Trust income, royalties" onchange="handleFieldChange('incomeOtherSource', this.value)">
                        </div>
                    </div>

                    <div style="background: var(--gray-100); padding: 16px; border-radius: 8px; margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600; color: var(--gray-700);">Total Annual Income</span>
                            <span style="font-size: 24px; font-weight: 700; color: var(--primary);" id="totalIncomeDisplay">¬£0</span>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 24px;">
                        <label class="form-label">Your Tax Position <span class="required">*</span></label>
                        <div class="option-group" id="taxRateOptions">
                            <div class="option-item">
                                <input type="radio" name="taxRate" id="taxNil" value="nil" onchange="handleFieldChange('taxRate', 'nil')">
                                <label for="taxNil">Non-taxpayer</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" name="taxRate" id="taxBasic" value="basic" onchange="handleFieldChange('taxRate', 'basic')">
                                <label for="taxBasic">Basic Rate (20%)</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" name="taxRate" id="taxHigher" value="higher" onchange="handleFieldChange('taxRate', 'higher')">
                                <label for="taxHigher">Higher Rate (40%)</label>
                            </div>
                            <div class="option-item">
                                <input type="radio" name="taxRate" id="taxAdditional" value="additional" onchange="handleFieldChange('taxRate', 'additional')">
                                <label for="taxAdditional">Additional Rate (45%)</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="applicant-form" id="applicant2Form2">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Employment Income</label>
                            <div class="currency-input" data-currency="¬£">
                                <input type="number" class="form-input" id="incomeEmployment_customer2" placeholder="0" style="padding-left: 28px;" onchange="handleFieldChange('incomeEmployment_customer2', this.value)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pension Income</label>
                            <div class="currency-input" data-currency="¬£">
                                <input type="number" class="form-input" id="incomePension_customer2" placeholder="0" style="padding-left: 28px;" onchange="handleFieldChange('incomePension_customer2', this.value)">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Investment Income</label>
                            <div class="currency-input" data-currency="¬£">
                                <input type="number" class="form-input" id="incomeInvestments_customer2" placeholder="0" style="padding-left: 28px;" onchange="handleFieldChange('incomeInvestments_customer2', this.value)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Other Income</label>
                            <div class="currency-input" data-currency="¬£">
                                <input type="number" class="form-input" id="incomeOther_customer2" placeholder="0" style="padding-left: 28px;" onchange="handleFieldChange('incomeOther_customer2', this.value)">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-actions">
                    <button class="btn btn-secondary" onclick="goToSection(1)">‚Üê Previous</button>
                    <button class="btn btn-primary" onclick="completeSection(2)">Continue ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Section 11: Source of Wealth (Enhanced) -->
        <div class="section-card" data-section="3" id="section3">
            <div class="section-header" onclick="toggleSection(3)">
                <div class="section-header-left">
                    <div class="section-number">11</div>
                    <div class="section-info">
                        <h3>Source of Wealth</h3>
                        <p>How you've accumulated your overall wealth</p>
                    </div>
                </div>
                <div class="section-status">
                    <span class="status-badge pending" id="status3">Not started</span>
                    <span class="toggle-icon">‚ñº</span>
                </div>
            </div>
            <div class="section-content">
                <div class="applicant-toggle" id="applicantToggle3" style="display: none;">
                    <button class="applicant-btn active" onclick="switchApplicant(3, 1)">Primary Applicant</button>
                    <button class="applicant-btn" onclick="switchApplicant(3, 2)">Joint Applicant</button>
                </div>

                <div class="applicant-form active" id="applicant1Form3">
                    <div class="info-box">
                        <p>‚ÑπÔ∏è Source of Wealth refers to how you have accumulated your total wealth over time. This is a regulatory requirement for AML compliance. Additional questions may appear based on your answers.</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Total Net Wealth (estimate) <span class="required">*</span></label>
                        <select class="form-select" id="totalNetWealth" onchange="handleFieldChange('totalNetWealth', this.value)">
                            <option value="">Select range</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-top: 24px;">
                        <label class="form-label">How was your wealth acquired? <span class="required">*</span></label>
                        <p class="form-hint" style="margin-bottom: 12px;">Add each source of wealth below. Higher risk sources will require additional information.</p>
                    </div>

                    <div id="sowSourcesContainer"></div>

                    <button class="btn-add-source" onclick="addSOWSource()">+ Add Another Source of Wealth</button>
                </div>

                <div class="applicant-form" id="applicant2Form3">
                    <div class="form-group">
                        <label class="form-label">Total Net Wealth (estimate)</label>
                        <select class="form-select" id="totalNetWealth_customer2" onchange="handleFieldChange('totalNetWealth_customer2', this.value)">
                            <option value="">Select range</option>
                        </select>
                    </div>
                    <div id="sowSourcesContainer_customer2" style="margin-top: 16px;"></div>
                    <button class="btn-add-source" onclick="addSOWSource('_customer2')" style="margin-top: 12px;">+ Add Source of Wealth</button>
                </div>

                <div class="section-actions">
                    <button class="btn btn-secondary" onclick="goToSection(2)">‚Üê Previous</button>
                    <button class="btn btn-primary" onclick="completeSection(3)">Continue ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Section 12: Source of Funds -->
        <div class="section-card" data-section="4" id="section4">
            <div class="section-header" onclick="toggleSection(4)">
                <div class="section-header-left">
                    <div class="section-number">12</div>
                    <div class="section-info">
                        <h3>Source of Funds</h3>
                        <p>Where the funds for this investment are coming from</p>
                    </div>
                </div>
                <div class="section-status">
                    <span class="status-badge pending" id="status4">Not started</span>
                    <span class="toggle-icon">‚ñº</span>
                </div>
            </div>
            <div class="section-content">
                <div class="applicant-toggle" id="applicantToggle4" style="display: none;">
                    <button class="applicant-btn active" onclick="switchApplicant(4, 1)">Primary Applicant</button>
                    <button class="applicant-btn" onclick="switchApplicant(4, 2)">Joint Applicant</button>
                </div>

                <div class="applicant-form active" id="applicant1Form4">
                    <div class="info-box">
                        <p>‚ÑπÔ∏è Source of Funds refers specifically to the money you will be investing with us. This may differ from your overall source of wealth.</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Intended Investment Amount <span class="required">*</span></label>
                        <div class="currency-input" data-currency="¬£">
                            <input type="number" class="form-input" id="investmentAmount" placeholder="0" style="padding-left: 28px;" onchange="handleFieldChange('investmentAmount', this.value)">
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 24px;">
                        <label class="form-label">Where are these funds coming from? <span class="required">*</span></label>
                        <div class="option-group" style="flex-direction: column; gap: 8px;">
                            <div class="option-item" style="width: 100%;">
                                <input type="checkbox" name="fundSource" id="fundSavings" value="savings" onchange="handleFundSourceChange('savings', this.checked)">
                                <label for="fundSavings" style="width: 100%;">Savings / Cash in bank</label>
                            </div>
                            <div class="option-item" style="width: 100%;">
                                <input type="checkbox" name="fundSource" id="fundTransfer" value="transfer" onchange="handleFundSourceChange('transfer', this.checked)">
                                <label for="fundTransfer" style="width: 100%;">Transfer from another investment manager</label>
                            </div>
                            <div class="option-item" style="width: 100%;">
                                <input type="checkbox" name="fundSource" id="fundPropertySale" value="property-sale" onchange="handleFundSourceChange('property-sale', this.checked)">
                                <label for="fundPropertySale" style="width: 100%;">Proceeds from property sale</label>
                            </div>
                            <div class="option-item" style="width: 100%;">
                                <input type="checkbox" name="fundSource" id="fundInheritance" value="inheritance" onchange="handleFundSourceChange('inheritance', this.checked)">
                                <label for="fundInheritance" style="width: 100%;">Inheritance</label>
                            </div>
                            <div class="option-item" style="width: 100%;">
                                <input type="checkbox" name="fundSource" id="fundPension" value="pension" onchange="handleFundSourceChange('pension', this.checked)">
                                <label for="fundPension" style="width: 100%;">Pension lump sum / PCLS</label>
                            </div>
                            <div class="option-item" style="width: 100%;">
                                <input type="checkbox" name="fundSource" id="fundOther" value="other" onchange="handleFundSourceChange('other', this.checked); toggleOtherFundSource(this.checked)">
                                <label for="fundOther" style="width: 100%;">Other</label>
                            </div>
                        </div>
                    </div>

                    <div class="conditional-section" id="otherFundSourceSection">
                        <div class="form-group">
                            <label class="form-label">Please specify the source</label>
                            <input type="text" class="form-input" id="otherFundSourceDetail" placeholder="Describe the source" onchange="handleFieldChange('otherFundSourceDetail', this.value)">
                        </div>
                    </div>

                    <div class="conditional-section visible" id="fundSourceDetailSection" style="margin-top: 20px;">
                        <div class="form-group">
                            <label class="form-label">Please provide more details about the source of these funds <span class="required">*</span></label>
                            <textarea class="form-textarea" id="fundSourceDetails" placeholder="Example: Proceeds from sale of property at 14 High Street, London in March 2024 for ¬£500,000. Now held in Barclays savings account." onchange="handleFieldChange('fundSourceDetails', this.value)"></textarea>
                            <span class="form-hint">Please be specific - include dates, amounts, and institutions where applicable</span>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 24px;">
                        <label class="form-label">If transferring from another manager, please provide:</label>
                        <div class="form-row" style="margin-top: 12px;">
                            <div class="form-group">
                                <label class="form-label">Manager/Broker Name</label>
                                <input type="text" class="form-input" id="transferManagerName" placeholder="e.g. Hargreaves Lansdown" onchange="handleFieldChange('transferManagerName', this.value)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Account/Reference Number</label>
                                <input type="text" class="form-input" id="transferAccountRef" placeholder="Account reference" onchange="handleFieldChange('transferAccountRef', this.value)">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="applicant-form" id="applicant2Form4">
                    <div class="form-group">
                        <label class="form-label">Contribution to Joint Investment</label>
                        <div class="currency-input" data-currency="¬£">
                            <input type="number" class="form-input" id="investmentAmount_customer2" placeholder="0" style="padding-left: 28px;" onchange="handleFieldChange('investmentAmount_customer2', this.value)">
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 16px;">
                        <label class="form-label">Source of Funds</label>
                        <select class="form-select" id="fundSource_customer2" onchange="handleFieldChange('fundSource_customer2', this.value)">
                            <option value="">Select source</option>
                            <option value="savings">Savings / Cash</option>
                            <option value="transfer">Transfer from another manager</option>
                            <option value="property-sale">Property Sale</option>
                            <option value="inheritance">Inheritance</option>
                            <option value="pension">Pension lump sum</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="section-actions">
                    <button class="btn btn-secondary" onclick="goToSection(3)">‚Üê Previous</button>
                    <button class="btn btn-success" onclick="completeSection(4); completeForm()">Complete Section ‚úì</button>
                </div>
            </div>
        </div>

        <div class="page-navigation">
            <a href="factfind_01_personal_information.html" class="nav-btn nav-btn-prev">‚Üê Back to Personal Information</a>
            <button class="nav-btn nav-btn-next" onclick="proceedToNextForm()" id="nextFormBtn" disabled>
                Continue to Investment Suitability ‚Üí
            </button>
        </div>
    </main>

    <script>
        // =========================================
        // JURISDICTION CONFIGURATION
        // =========================================
        const JURISDICTION_CONFIG = {
            UK: {
                code: 'UK',
                currency: '¬£',
                currencyCode: 'GBP',
                netWorthBands: [
                    { value: 'under-100k', label: 'Under ¬£100,000' },
                    { value: '100k-250k', label: '¬£100,000 - ¬£250,000' },
                    { value: '250k-500k', label: '¬£250,000 - ¬£500,000' },
                    { value: '500k-1m', label: '¬£500,000 - ¬£1,000,000' },
                    { value: '1m-5m', label: '¬£1,000,000 - ¬£5,000,000' },
                    { value: 'over-5m', label: 'Over ¬£5,000,000' }
                ],
                incomeBands: [
                    { value: 'under-25k', label: 'Under ¬£25,000' },
                    { value: '25k-50k', label: '¬£25,000 - ¬£50,000' },
                    { value: '50k-100k', label: '¬£50,000 - ¬£100,000' },
                    { value: '100k-200k', label: '¬£100,000 - ¬£200,000' },
                    { value: 'over-200k', label: 'Over ¬£200,000' }
                ],
                taxRates: [
                    { value: 'nil', label: 'Non-taxpayer' },
                    { value: 'basic', label: 'Basic Rate (20%)' },
                    { value: 'higher', label: 'Higher Rate (40%)' },
                    { value: 'additional', label: 'Additional Rate (45%)' }
                ],
                examplePlaceholder: 'Example: Proceeds from sale of property at 14 High Street, London in March 2024 for ¬£500,000. Now held in Barclays savings account.'
            },
            IE: {
                code: 'IE',
                currency: '‚Ç¨',
                currencyCode: 'EUR',
                netWorthBands: [
                    { value: 'under-100k', label: 'Under ‚Ç¨100,000' },
                    { value: '100k-300k', label: '‚Ç¨100,000 - ‚Ç¨300,000' },
                    { value: '300k-600k', label: '‚Ç¨300,000 - ‚Ç¨600,000' },
                    { value: '600k-1m', label: '‚Ç¨600,000 - ‚Ç¨1,000,000' },
                    { value: '1m-3m', label: '‚Ç¨1,000,000 - ‚Ç¨3,000,000' },
                    { value: 'over-3m', label: 'Over ‚Ç¨3,000,000' }
                ],
                incomeBands: [
                    { value: 'under-30k', label: 'Under ‚Ç¨30,000' },
                    { value: '30k-60k', label: '‚Ç¨30,000 - ‚Ç¨60,000' },
                    { value: '60k-120k', label: '‚Ç¨60,000 - ‚Ç¨120,000' },
                    { value: '120k-250k', label: '‚Ç¨120,000 - ‚Ç¨250,000' },
                    { value: 'over-250k', label: 'Over ‚Ç¨250,000' }
                ],
                taxRates: [
                    { value: 'standard', label: 'Standard Rate (20%)' },
                    { value: 'marginal', label: 'Marginal Rate (40%)' }
                ],
                examplePlaceholder: 'Example: Proceeds from sale of property at 14 Main Street, Dublin in March 2024 for ‚Ç¨500,000. Now held in AIB savings account.'
            }
        };
        
        const STORAGE_KEY = 'evelynFactFindFinancial';
        const TOTAL_SECTIONS = 4;
        
        let formData = {};
        let sectionStatus = {};
        let isJointApplication = false;
        let currentJurisdiction = 'UK';
        let saveTimeout = null;
        let wealthSourceCount = 1;
        let selectedFundSources = [];

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            isJointApplication = urlParams.get('type') === 'joint';
            
            // Get jurisdiction from URL or localStorage
            const urlJurisdiction = urlParams.get('jurisdiction');
            if (urlJurisdiction && JURISDICTION_CONFIG[urlJurisdiction]) {
                currentJurisdiction = urlJurisdiction;
            } else {
                const storedJurisdiction = localStorage.getItem('evelynJurisdiction');
                if (storedJurisdiction && JURISDICTION_CONFIG[storedJurisdiction]) {
                    currentJurisdiction = storedJurisdiction;
                }
            }
            
            // Apply jurisdiction-specific UI updates
            applyJurisdictionConfig();
            
            if (isJointApplication) {
                document.getElementById('applicationTypeBadge').textContent = 'Joint Application';
                document.querySelectorAll('.applicant-toggle').forEach(el => el.style.display = 'flex');
            }

            loadSavedData();
            
            for (let i = 1; i <= TOTAL_SECTIONS; i++) {
                if (!sectionStatus[i]) sectionStatus[i] = 'pending';
                updateSectionUI(i);
            }
            updateProgress();
            
            // Initialize Source of Wealth section
            initSOWSources();
        });
        
        // =========================================
        // JURISDICTION HANDLING
        // =========================================
        function applyJurisdictionConfig() {
            const config = JURISDICTION_CONFIG[currentJurisdiction];
            
            // Update all currency symbols via data-currency attribute
            document.querySelectorAll('.currency-input').forEach(el => {
                el.setAttribute('data-currency', config.currency);
            });
            
            // Update total income display
            const totalIncomeDisplay = document.getElementById('totalIncomeDisplay');
            if (totalIncomeDisplay) {
                const currentValue = totalIncomeDisplay.textContent.replace(/[¬£‚Ç¨,]/g, '') || '0';
                totalIncomeDisplay.textContent = config.currency + parseInt(currentValue).toLocaleString();
            }
            
            // Update net worth dropdowns
            updateSelectOptions('totalNetWealth', config.netWorthBands);
            updateSelectOptions('totalNetWealth_customer2', config.netWorthBands);
            
            // Update tax rate options
            updateTaxRateOptions(config.taxRates);
            
            // Update example placeholder text
            const fundSourceDetails = document.getElementById('fundSourceDetails');
            if (fundSourceDetails) {
                fundSourceDetails.placeholder = config.examplePlaceholder;
            }
            
            // Store jurisdiction in form data
            formData.jurisdiction = currentJurisdiction;
            formData.currencyCode = config.currencyCode;
        }
        
        function updateTaxRateOptions(taxRates) {
            // Primary applicant tax rates
            const taxGroup = document.getElementById('taxRateOptions');
            if (taxGroup) {
                taxGroup.innerHTML = '';
                taxRates.forEach((rate, index) => {
                    const optionItem = document.createElement('div');
                    optionItem.className = 'option-item';
                    optionItem.innerHTML = `
                        <input type="radio" name="taxRate" id="tax${index}" value="${rate.value}" onchange="handleFieldChange('taxRate', '${rate.value}')">
                        <label for="tax${index}">${rate.label}</label>
                    `;
                    taxGroup.appendChild(optionItem);
                });
                
                // Restore previous selection if it exists
                if (formData.taxRate) {
                    const radio = document.querySelector(`input[name="taxRate"][value="${formData.taxRate}"]`);
                    if (radio) radio.checked = true;
                }
            }
        }
        
        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId);
            if (select) {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Select range</option>';
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    select.appendChild(option);
                });
                // Restore previous selection if it exists
                if (currentValue) select.value = currentValue;
            }
        }

        function loadSavedData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                formData = parsed.formData || {};
                sectionStatus = parsed.sectionStatus || {};
                
                Object.keys(formData).forEach(key => {
                    const value = formData[key];
                    
                    // First, try to find element by ID
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = value === true || value === 'true' || value === 'on';
                        } else {
                            element.value = value;
                        }
                    }
                    
                    // Also check for radio buttons by name
                    const radios = document.querySelectorAll(`input[type="radio"][name="${key}"]`);
                    if (radios.length > 0) {
                        radios.forEach(radio => {
                            if (radio.value === value) {
                                radio.checked = true;
                            }
                        });
                    }
                });
                
                // Restore conditional sections
                restoreConditionalSections();

                updateSaveStatus('saved');
            }
        }
        
        // Restore visibility of conditional sections based on loaded data
        function restoreConditionalSections() {
            // Employment type conditional fields
            const empStatus = formData.employmentStatus;
            if (empStatus === 'employed' || empStatus === 'selfEmployed') {
                const empDetails = document.getElementById('employmentDetails');
                if (empDetails) empDetails.classList.add('visible');
            }
            if (empStatus === 'retired') {
                const retiredDetails = document.getElementById('retiredDetails');
                if (retiredDetails) retiredDetails.classList.add('visible');
            }
            
            // Source of wealth - other
            if (formData.sourceOfWealth === 'other') {
                const otherSection = document.getElementById('otherWealthSection');
                if (otherSection) otherSection.classList.add('visible');
            }
            
            // Source of funds - other
            if (formData.sourceOfFunds === 'other') {
                const otherSection = document.getElementById('otherFundsSection');
                if (otherSection) otherSection.classList.add('visible');
            }
        }

        function saveProgress() {
            const dataToSave = {
                formData: formData,
                sectionStatus: sectionStatus,
                lastSaved: new Date().toISOString()
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            updateSaveStatus('saved');
        }

        function handleFieldChange(fieldName, value) {
            formData[fieldName] = value;
            updateSaveStatus('saving');
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveProgress(), 500);
        }

        function updateSaveStatus(status) {
            const icon = document.getElementById('saveStatusIcon');
            const text = document.getElementById('saveStatusText');
            icon.className = 'save-status-icon';
            if (status === 'saved') {
                icon.classList.add('saved');
                text.textContent = 'All changes saved';
            } else if (status === 'saving') {
                icon.classList.add('saving');
                text.textContent = 'Saving...';
            }
        }

        function clearForm() {
            if (confirm('Clear all data? This cannot be undone.')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // Scroll to section with offset to account for sticky header
        function scrollToSectionWithOffset(element) {
            const header = document.querySelector('.header');
            const headerHeight = header ? header.offsetHeight : 0;
            const offset = headerHeight + 20;
            const elementPosition = element.getBoundingClientRect().top;
            const currentScrollPosition = window.pageYOffset;
            const targetPosition = currentScrollPosition + elementPosition - offset;
            window.scrollTo({ top: targetPosition, behavior: 'smooth' });
        }

        function toggleSection(sectionNum) {
            const section = document.getElementById(`section${sectionNum}`);
            const wasExpanded = section.classList.contains('expanded');
            document.querySelectorAll('.section-card').forEach(card => card.classList.remove('expanded'));
            if (!wasExpanded) {
                section.classList.add('expanded');
                setTimeout(() => scrollToSectionWithOffset(section), 100);
            }
        }

        function goToSection(sectionNum) { toggleSection(sectionNum); }

        function completeSection(sectionNum) {
            sectionStatus[sectionNum] = 'completed';
            updateSectionUI(sectionNum);
            saveProgress();
            if (sectionNum < TOTAL_SECTIONS) toggleSection(sectionNum + 1);
            updateProgress();
        }

        function updateSectionUI(sectionNum) {
            const section = document.getElementById(`section${sectionNum}`);
            const statusBadge = document.getElementById(`status${sectionNum}`);
            const progressStep = document.querySelector(`.progress-step[data-section="${sectionNum}"]`);
            
            section.classList.remove('completed');
            progressStep.classList.remove('completed', 'active');
            
            if (sectionStatus[sectionNum] === 'completed') {
                section.classList.add('completed');
                statusBadge.className = 'status-badge completed';
                statusBadge.textContent = 'Completed';
                progressStep.classList.add('completed');
            } else {
                statusBadge.className = 'status-badge pending';
                statusBadge.textContent = 'Not started';
            }
        }

        function updateProgress() {
            const completed = Object.values(sectionStatus).filter(s => s === 'completed').length;
            const percent = Math.round((completed / TOTAL_SECTIONS) * 100);
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressPercent').textContent = `${percent}% Complete`;
            document.getElementById('nextFormBtn').disabled = completed !== TOTAL_SECTIONS;
        }

        function switchApplicant(sectionNum, applicantNum) {
            const toggle = document.getElementById(`applicantToggle${sectionNum}`);
            toggle.querySelectorAll('.applicant-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i + 1 === applicantNum);
            });
            document.getElementById(`applicant1Form${sectionNum}`).classList.toggle('active', applicantNum === 1);
            document.getElementById(`applicant2Form${sectionNum}`).classList.toggle('active', applicantNum === 2);
        }

        function handleEmploymentChange(status) {
            handleFieldChange('employmentStatus', status);
            document.getElementById('employedSection').classList.toggle('visible', status === 'employed');
            document.getElementById('selfEmployedSection').classList.toggle('visible', status === 'self-employed');
            document.getElementById('retiredSection').classList.toggle('visible', status === 'retired');
        }

        function calculateTotalIncome() {
            const employment = parseFloat(document.getElementById('incomeEmployment').value) || 0;
            const pension = parseFloat(document.getElementById('incomePension').value) || 0;
            const investments = parseFloat(document.getElementById('incomeInvestments').value) || 0;
            const rental = parseFloat(document.getElementById('incomeRental').value) || 0;
            const other = parseFloat(document.getElementById('incomeOther').value) || 0;
            const total = employment + pension + investments + rental + other;
            const currencySymbol = JURISDICTION_CONFIG[currentJurisdiction].currency;
            document.getElementById('totalIncomeDisplay').textContent = currencySymbol + total.toLocaleString();
            handleFieldChange('totalIncome', total);
        }

        // =========================================
        // ENHANCED SOURCE OF WEALTH CONFIGURATION
        // =========================================
        const HIGHER_RISK_JURISDICTIONS = [
            'Afghanistan', 'Albania', 'Belarus', 'Burkina Faso', 'Cameroon', 'Cayman Islands',
            'Croatia', 'Democratic Republic of Congo', 'Gibraltar', 'Haiti', 'Iran', 'Jamaica',
            'Jordan', 'Mali', 'Monaco', 'Mozambique', 'Myanmar', 'Nigeria', 'North Korea',
            'Pakistan', 'Panama', 'Philippines', 'Russia', 'Senegal', 'South Africa', 'South Sudan',
            'Syria', 'Tanzania', 'Turkey', 'Uganda', 'UAE', 'Venezuela', 'Vietnam', 'Yemen'
        ];

        const HIGHER_RISK_INDUSTRIES = [
            'arms-defense', 'gambling', 'crypto', 'cash-intensive', 'precious-metals',
            'art-antiques', 'adult', 'construction', 'money-services', 'private-security',
            'oil-gas', 'shipping', 'tobacco', 'pharmaceuticals-unlicensed'
        ];

        const ALL_INDUSTRIES = [
            { value: 'accounting', label: 'Accounting / Finance' },
            { value: 'agriculture', label: 'Agriculture / Farming' },
            { value: 'arms-defense', label: 'Arms / Defence / Military ‚ö†Ô∏è', highRisk: true },
            { value: 'art-antiques', label: 'Art / Antiques dealing ‚ö†Ô∏è', highRisk: true },
            { value: 'banking', label: 'Banking / Financial Services (Regulated)' },
            { value: 'cash-intensive', label: 'Cash-intensive (retail, hospitality) ‚ö†Ô∏è', highRisk: true },
            { value: 'charity', label: 'Charity / Non-profit' },
            { value: 'construction', label: 'Construction ‚ö†Ô∏è', highRisk: true },
            { value: 'consulting', label: 'Consulting / Professional Services' },
            { value: 'crypto', label: 'Cryptocurrency / Digital Assets ‚ö†Ô∏è', highRisk: true },
            { value: 'education', label: 'Education' },
            { value: 'engineering', label: 'Engineering' },
            { value: 'gambling', label: 'Gambling / Betting / Casinos ‚ö†Ô∏è', highRisk: true },
            { value: 'government', label: 'Government / Public Sector' },
            { value: 'healthcare', label: 'Healthcare / Medical' },
            { value: 'hospitality', label: 'Hospitality / Hotels' },
            { value: 'insurance', label: 'Insurance' },
            { value: 'it-tech', label: 'IT / Technology' },
            { value: 'legal', label: 'Legal Services' },
            { value: 'manufacturing', label: 'Manufacturing' },
            { value: 'media', label: 'Media / Entertainment' },
            { value: 'money-services', label: 'Money Services / FX ‚ö†Ô∏è', highRisk: true },
            { value: 'oil-gas', label: 'Oil & Gas / Mining ‚ö†Ô∏è', highRisk: true },
            { value: 'pharmaceuticals', label: 'Pharmaceuticals (Regulated)' },
            { value: 'precious-metals', label: 'Precious Metals / Gems ‚ö†Ô∏è', highRisk: true },
            { value: 'real-estate', label: 'Real Estate / Property' },
            { value: 'retail', label: 'Retail' },
            { value: 'shipping', label: 'Shipping / Maritime ‚ö†Ô∏è', highRisk: true },
            { value: 'telecoms', label: 'Telecommunications' },
            { value: 'transport', label: 'Transport / Logistics' },
            { value: 'other', label: 'Other' }
        ];

        const COUNTRIES_LIST = [
            'Ireland', 'United Kingdom', '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ',
            'Afghanistan', 'Albania', 'Australia', 'Austria', 'Belgium', 'Brazil', 'Canada', 
            'Cayman Islands', 'China', 'Cyprus', 'Denmark', 'Finland', 'France', 'Germany', 
            'Gibraltar', 'Greece', 'Hong Kong', 'India', 'Iran', 'Israel', 'Italy', 'Japan', 
            'Luxembourg', 'Malta', 'Monaco', 'Netherlands', 'New Zealand', 'Nigeria', 'North Korea',
            'Norway', 'Pakistan', 'Panama', 'Philippines', 'Poland', 'Portugal', 'Russia', 
            'Saudi Arabia', 'Singapore', 'South Africa', 'Spain', 'Sweden', 'Switzerland', 
            'Turkey', 'UAE', 'United States', 'Venezuela', 'Other'
        ];

        const SOW_CATEGORIES = {
            'salary': {
                label: 'Salary / Employment Income',
                alwaysHighRisk: false,
                questions: [
                    { id: 'employmentStatus', label: 'Employment Status', type: 'select', required: true, 
                      options: ['Employed', 'Self-Employed', 'Director', 'Partner', 'Contractor', 'Shareholder/Owner'] },
                    { id: 'jobTitle', label: 'Job Title', type: 'text', required: true },
                    { id: 'salary', label: 'Annual Salary/Income', type: 'currency', required: true },
                    { id: 'bonus', label: 'Annual Bonus/Dividend (if any)', type: 'currency', required: false },
                    { id: 'employerName', label: "Employer's Name", type: 'text', required: true },
                    { id: 'industry', label: 'Nature of Business/Industry', type: 'industry', required: true },
                    { id: 'employmentLength', label: 'Length of Employment', type: 'text', required: true, placeholder: 'e.g. 5 years' },
                    { id: 'employmentCountry', label: 'Country of Employment', type: 'country', required: true },
                    { id: 'payingCountry', label: 'Country of Paying Entity', type: 'country', required: true }
                ],
                riskQuestions: [
                    { id: 'shareholdingPct', label: 'What % shareholding do you hold?', type: 'select',
                      options: ['None', 'Under 10%', '10-25%', '25-50%', '50-75%', 'Over 75%'] },
                    { id: 'roleDescription', label: 'Description of role within the business', type: 'textarea' }
                ]
            },
            'pension': {
                label: 'Retirement Income (Pensions)',
                alwaysHighRisk: false,
                questions: [
                    { id: 'pensionCompany', label: 'Company where pension was generated', type: 'text', required: true },
                    { id: 'industry', label: 'Nature of that company/industry', type: 'industry', required: true },
                    { id: 'pensionAmount', label: 'Annual pension income', type: 'currency', required: true },
                    { id: 'datesWorked', label: 'Dates worked', type: 'text', required: true, placeholder: 'e.g. 1985-2020' },
                    { id: 'retirementDate', label: 'Date of retirement', type: 'date', required: true },
                    { id: 'lastJobTitle', label: 'Most recent job title', type: 'text', required: true },
                    { id: 'employmentCountry', label: 'Country of employment', type: 'country', required: true }
                ],
                riskQuestions: [
                    { id: 'roleDescription', label: 'Description of role within the business', type: 'textarea' }
                ]
            },
            'business-profits': {
                label: 'Business Profits',
                alwaysHighRisk: false,
                questions: [
                    { id: 'annualProfits', label: 'Amount of annual profits', type: 'currency', required: true },
                    { id: 'companyName', label: 'Name of company', type: 'text', required: true },
                    { id: 'companyNumber', label: 'Company registration number', type: 'text', required: true },
                    { id: 'dateEstablished', label: 'Date company established', type: 'date', required: true },
                    { id: 'registrationCountry', label: 'Country of registration', type: 'country', required: true },
                    { id: 'industry', label: 'Nature of industry', type: 'industry', required: true },
                    { id: 'linkedCountries', label: 'Other countries company has links to', type: 'text', placeholder: 'List countries' },
                    { id: 'shareholding', label: 'Your shareholding %', type: 'select', required: true,
                      options: ['Under 10%', '10-25%', '25-50%', '50-75%', 'Over 75%', '100%'] },
                    { id: 'companiesHouseMatch', label: 'Do Companies House statements evidence the wealth?', type: 'select', required: true,
                      options: ['Yes', 'No', 'Not applicable (non-UK/Irish)'] }
                ],
                riskQuestions: [
                    { id: 'nonUKIncome', label: 'Breakdown of income from non-UK/Irish jurisdictions (%)', type: 'textarea' },
                    { id: 'companiesHouseExplain', label: 'Explain why statements do not evidence wealth', type: 'textarea' }
                ]
            },
            'business-sale': {
                label: 'Sale of Business',
                alwaysHighRisk: false,
                questions: [
                    { id: 'companyName', label: 'Name of company sold', type: 'text', required: true },
                    { id: 'industry', label: 'Nature of business', type: 'industry', required: true },
                    { id: 'saleCountry', label: 'Country where sale took place', type: 'country', required: true },
                    { id: 'yearOfSale', label: 'Year of sale', type: 'number', required: true, placeholder: 'e.g. 2022' },
                    { id: 'soldTo', label: 'Who was it sold to?', type: 'text', required: true },
                    { id: 'totalSaleAmount', label: 'Total sale amount', type: 'currency', required: true },
                    { id: 'amountReceived', label: 'Amount you received', type: 'currency', required: true }
                ],
                riskQuestions: [
                    { id: 'retainedPosition', label: 'Retained any position/shareholding?', type: 'select',
                      options: ['No', 'Yes - shareholding only', 'Yes - position only', 'Yes - both'] },
                    { id: 'retainedPct', label: 'If yes, provide %', type: 'text' }
                ]
            },
            'property-investment': {
                label: 'Property Investment / Rental Income',
                alwaysHighRisk: false,
                questions: [
                    { id: 'propertyType', label: 'Type of properties', type: 'multiselect', required: true,
                      options: ['Residential - Houses', 'Residential - Flats', 'Commercial - Retail', 'Commercial - Office', 'Commercial - Industrial', 'Land', 'HMO'] },
                    { id: 'propertyLocations', label: 'Location of properties', type: 'textarea', required: true, placeholder: 'City/region for each property' },
                    { id: 'numberOfProperties', label: 'Number of properties', type: 'number', required: true },
                    { id: 'purchaseYears', label: 'Year(s) of purchase', type: 'text', required: true },
                    { id: 'purchaseValue', label: 'Total purchase value', type: 'currency', required: true },
                    { id: 'currentValue', label: 'Current value', type: 'currency', required: true },
                    { id: 'ownership', label: 'Owned personally or through company?', type: 'select', required: true,
                      options: ['Personally', 'Through a company', 'Mixed'] },
                    { id: 'originalFunding', label: 'How was the purchase originally funded?', type: 'select', required: true,
                      options: ['Salary/Savings', 'Inheritance', 'Gift', 'Business Profits', 'Other Property Sale', 'Mortgage', 'Other'] },
                    { id: 'annualRentalIncome', label: 'Annual rental income', type: 'currency', required: true }
                ],
                riskQuestions: [
                    { id: 'fullAddresses', label: 'Full addresses of properties', type: 'textarea' },
                    { id: 'incomePerProperty', label: 'Rental income per property', type: 'textarea' },
                    { id: 'mortgageDetails', label: 'Outstanding mortgage details', type: 'textarea' }
                ]
            },
            'property-sale': {
                label: 'Sale of Property',
                alwaysHighRisk: false,
                questions: [
                    { id: 'propertyAddress', label: 'Full address of property sold', type: 'textarea', required: true },
                    { id: 'propertyCountry', label: 'Country', type: 'country', required: true },
                    { id: 'saleDate', label: 'Date of sale', type: 'date', required: true },
                    { id: 'saleAmount', label: 'Sale amount', type: 'currency', required: true },
                    { id: 'purchaseAmount', label: 'Original purchase amount', type: 'currency', required: true },
                    { id: 'originalFunding', label: 'How was purchase originally funded?', type: 'select', required: true,
                      options: ['Salary/Savings', 'Inheritance', 'Gift', 'Business Profits', 'Other Property Sale', 'Mortgage', 'Other'] },
                    { id: 'netProceeds', label: 'Net proceeds after fees/mortgage', type: 'currency', required: true }
                ],
                riskQuestions: [
                    { id: 'purchaseDate', label: 'Date property was purchased', type: 'date' }
                ]
            },
            'inheritance': {
                label: 'Inheritance',
                alwaysHighRisk: false,
                questions: [
                    { id: 'amount', label: 'Total amount received', type: 'currency', required: true },
                    { id: 'dateReceived', label: 'Date received', type: 'date', required: true },
                    { id: 'deceasedName', label: 'Name of deceased', type: 'text', required: true },
                    { id: 'relationship', label: 'Relationship to deceased', type: 'select', required: true,
                      options: ['Parent', 'Grandparent', 'Spouse/Partner', 'Sibling', 'Aunt/Uncle', 'Other relative', 'Non-relative'] },
                    { id: 'yearOfDeath', label: 'Year of death', type: 'number', required: true },
                    { id: 'deceasedSOW', label: 'How did deceased acquire their wealth?', type: 'select', required: true,
                      options: ['Employment', 'Business', 'Property', 'Investments', 'Inheritance', 'Unknown', 'Other'] },
                    { id: 'deceasedPEP', label: 'Was deceased a Politically Exposed Person?', type: 'select', required: true,
                      options: ['No', 'Yes - domestic', 'Yes - foreign', 'Unknown'] },
                    { id: 'deceasedCountry', label: 'Country where deceased generated wealth', type: 'country', required: true }
                ],
                riskQuestions: [
                    { id: 'deceasedSOWDetail', label: 'Provide more detail on deceased\'s source of wealth', type: 'textarea' }
                ]
            },
            'gift': {
                label: 'Gift',
                alwaysHighRisk: false,
                questions: [
                    { id: 'amount', label: 'Total amount received', type: 'currency', required: true },
                    { id: 'dateReceived', label: 'Date received', type: 'date', required: true },
                    { id: 'donorName', label: 'Name of donor', type: 'text', required: true },
                    { id: 'relationship', label: 'Relationship to donor', type: 'select', required: true,
                      options: ['Parent', 'Grandparent', 'Spouse/Partner', 'Sibling', 'Other relative', 'Friend', 'Business associate', 'Other'] },
                    { id: 'donorSOW', label: 'How did donor acquire their wealth?', type: 'select', required: true,
                      options: ['Employment', 'Business', 'Property', 'Investments', 'Inheritance', 'Unknown', 'Other'] },
                    { id: 'donorPEP', label: 'Is/was donor a Politically Exposed Person?', type: 'select', required: true,
                      options: ['No', 'Yes - domestic', 'Yes - foreign', 'Unknown'] },
                    { id: 'donorCountry', label: 'Country where donor generated wealth', type: 'country', required: true }
                ],
                riskQuestions: [
                    { id: 'donorSOWDetail', label: 'Provide more detail on donor\'s source of wealth', type: 'textarea' }
                ]
            },
            'divorce': {
                label: 'Divorce Settlement',
                alwaysHighRisk: false,
                questions: [
                    { id: 'amount', label: 'Total amount received', type: 'currency', required: true },
                    { id: 'dateReceived', label: 'Date received', type: 'date', required: true },
                    { id: 'exSpouseName', label: 'Name of ex-spouse', type: 'text', required: true },
                    { id: 'exSpouseSOW', label: 'How did ex-spouse acquire their wealth?', type: 'select', required: true,
                      options: ['Employment', 'Business', 'Property', 'Investments', 'Inheritance', 'Unknown', 'Other'] },
                    { id: 'exSpousePEP', label: 'Is/was ex-spouse a PEP?', type: 'select', required: true,
                      options: ['No', 'Yes - domestic', 'Yes - foreign', 'Unknown'] },
                    { id: 'exSpouseCountry', label: 'Country where ex-spouse generated wealth', type: 'country', required: true }
                ],
                riskQuestions: [
                    { id: 'exSpouseSOWDetail', label: 'Provide more detail on ex-spouse\'s source of wealth', type: 'textarea' }
                ]
            },
            'compensation': {
                label: 'Personal Injury / Clinical Negligence',
                alwaysHighRisk: false,
                alwaysLowRisk: true,
                questions: [
                    { id: 'awardAmount', label: 'Total amount of award', type: 'currency', required: true },
                    { id: 'awardDate', label: 'Date of award', type: 'date', required: true }
                ],
                riskQuestions: []
            },
            'lottery': {
                label: 'Lottery / Betting / Casino Winnings',
                alwaysHighRisk: true,
                highRiskReason: 'Gambling-related wealth always requires enhanced due diligence.',
                questions: [
                    { id: 'winAmount', label: 'Total amount won', type: 'currency', required: true },
                    { id: 'winDate', label: 'Date of win', type: 'date', required: true },
                    { id: 'organisation', label: 'Organisation making payment', type: 'textarea', required: true, placeholder: 'Name and address' },
                    { id: 'winCountry', label: 'Country where winnings paid from', type: 'country', required: true },
                    { id: 'gamblingType', label: 'Type of gambling', type: 'select', required: true,
                      options: ['National Lottery', 'EuroMillions', 'Licensed Casino (UK/IE)', 'Offshore Casino', 'Sports Betting (Licensed)', 'Sports Betting (Offshore)', 'Online Gambling', 'Private Games', 'Other'] }
                ],
                riskQuestions: []
            },
            'insurance': {
                label: 'Insurance / Policy Payout',
                alwaysHighRisk: false,
                questions: [
                    { id: 'amount', label: 'Total amount received', type: 'currency', required: true },
                    { id: 'dateReceived', label: 'Date received', type: 'date', required: true },
                    { id: 'provider', label: 'Policy provider', type: 'text', required: true },
                    { id: 'policyNumber', label: 'Policy number', type: 'text', required: true },
                    { id: 'insuranceType', label: 'Type of payout', type: 'select', required: true,
                      options: ['Life Insurance', 'Annuity', 'Critical Illness', 'Income Protection', 'Property Insurance', 'High Value Asset', 'Other'] }
                ],
                riskQuestions: [
                    { id: 'livesAssured', label: 'Name of lives assured', type: 'text' },
                    { id: 'assetDetails', label: 'Details of high value asset', type: 'textarea' },
                    { id: 'fundingSource', label: 'How was policy/annuity originally funded?', type: 'textarea' }
                ]
            },
            'cryptocurrency': {
                label: 'Cryptocurrency',
                alwaysHighRisk: true,
                highRiskReason: 'Cryptocurrency wealth always requires enhanced due diligence due to anonymity risks.',
                questions: [
                    { id: 'originalFunding', label: 'Original source of funds for investment', type: 'select', required: true,
                      options: ['Salary/Savings', 'Business Profits', 'Inheritance', 'Gift', 'Other Investment Returns', 'Other'] },
                    { id: 'originalAmount', label: 'Original amount invested', type: 'currency', required: true },
                    { id: 'investmentDate', label: 'Date of original investment', type: 'date', required: true },
                    { id: 'currentValue', label: 'Current value', type: 'currency', required: true },
                    { id: 'whereHeld', label: 'Where is it currently held?', type: 'select', required: true,
                      options: ['Regulated Exchange (UK/EU)', 'Regulated Exchange (US)', 'Unregulated Exchange', 'Hardware Wallet', 'Software Wallet', 'Multiple locations'] },
                    { id: 'conversionDetails', label: 'When and how were assets converted to fiat currency?', type: 'textarea', required: true }
                ],
                riskQuestions: []
            }
        };

        let sowSources = { '': {}, '_customer2': {} };

        function getSOWSourceCount(suffix = '') {
            const containerId = suffix ? 'sowSourcesContainer_customer2' : 'sowSourcesContainer';
            const container = document.getElementById(containerId);
            return container ? container.querySelectorAll('.sow-category-card').length : 0;
        }

        function addSOWSource(suffix = '') {
            const containerId = suffix ? 'sowSourcesContainer_customer2' : 'sowSourcesContainer';
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const currentCount = getSOWSourceCount(suffix);
            const newIndex = currentCount + 1;
            const currencySymbol = JURISDICTION_CONFIG[currentJurisdiction].currency;
            
            const sourceCard = document.createElement('div');
            sourceCard.className = 'sow-category-card';
            sourceCard.id = `sowSource${suffix}${newIndex}`;
            sourceCard.setAttribute('data-sow-index', newIndex);
            sourceCard.innerHTML = `
                <div class="sow-category-header">
                    <span class="sow-category-title">Source ${newIndex}</span>
                    ${newIndex > 1 ? `<button class="btn-remove" onclick="removeSOWSource(this, '${suffix}')">‚úï Remove</button>` : ''}
                </div>
                <div class="form-group">
                    <label class="form-label">Source Type <span class="required">*</span></label>
                    <select class="form-select sow-type-select" onchange="handleSOWTypeChange(this, '${suffix}')">
                        <option value="">Select source of wealth</option>
                        <option value="salary">Salary / Employment Income</option>
                        <option value="pension">Retirement Income (Pensions)</option>
                        <option value="business-profits">Business Profits</option>
                        <option value="business-sale">Sale of Business</option>
                        <option value="property-investment">Property Investment / Rental Income</option>
                        <option value="property-sale">Sale of Property</option>
                        <option value="inheritance">Inheritance</option>
                        <option value="gift">Gift</option>
                        <option value="divorce">Divorce Settlement</option>
                        <option value="compensation">Personal Injury / Clinical Negligence</option>
                        <option value="lottery">Lottery / Betting / Casino Winnings</option>
                        <option value="insurance">Insurance / Policy Payout</option>
                        <option value="cryptocurrency">Cryptocurrency</option>
                    </select>
                </div>
                <div class="sow-questions-container"></div>
                <div class="sow-risk-section risk-trigger-section" style="display: none;"></div>
            `;
            container.appendChild(sourceCard);
            
            sowSources[suffix][newIndex] = { type: null, data: {}, hasRisk: false };
        }

        function removeSOWSource(buttonElement, suffix = '') {
            const card = buttonElement.closest('.sow-category-card');
            if (card) {
                card.remove();
                renumberSOWSources(suffix);
            }
        }

        function renumberSOWSources(suffix = '') {
            const containerId = suffix ? 'sowSourcesContainer_customer2' : 'sowSourcesContainer';
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const cards = container.querySelectorAll('.sow-category-card');
            const newSources = {};
            
            cards.forEach((card, idx) => {
                const newIndex = idx + 1;
                const oldIndex = parseInt(card.getAttribute('data-sow-index'));
                
                // Update card ID and data attribute
                card.id = `sowSource${suffix}${newIndex}`;
                card.setAttribute('data-sow-index', newIndex);
                
                // Update title
                const title = card.querySelector('.sow-category-title');
                if (title) title.textContent = `Source ${newIndex}`;
                
                // Update remove button (hide for first source, show for others)
                const header = card.querySelector('.sow-category-header');
                const existingRemoveBtn = header.querySelector('.btn-remove');
                if (newIndex === 1 && existingRemoveBtn) {
                    existingRemoveBtn.remove();
                } else if (newIndex > 1 && !existingRemoveBtn) {
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'btn-remove';
                    removeBtn.textContent = '‚úï Remove';
                    removeBtn.onclick = function() { removeSOWSource(this, suffix); };
                    header.appendChild(removeBtn);
                }
                
                // Transfer data to new index
                if (sowSources[suffix][oldIndex]) {
                    newSources[newIndex] = sowSources[suffix][oldIndex];
                }
            });
            
            // Replace sources object
            sowSources[suffix] = newSources;
        }

        function handleSOWTypeChange(selectElement, suffix = '') {
            const card = selectElement.closest('.sow-category-card');
            const index = parseInt(card.getAttribute('data-sow-index'));
            const type = selectElement.value;
            const questionsContainer = card.querySelector('.sow-questions-container');
            const riskSection = card.querySelector('.sow-risk-section');
            
            sowSources[suffix][index] = { type: type, data: {}, hasRisk: false };
            handleFieldChange(`sow${suffix}${index}_type`, type);
            
            if (!type) {
                questionsContainer.innerHTML = '';
                riskSection.style.display = 'none';
                card.classList.remove('has-risk');
                return;
            }
            
            const category = SOW_CATEGORIES[type];
            const currencySymbol = JURISDICTION_CONFIG[currentJurisdiction].currency;
            
            let html = '';
            
            // Show risk notices
            if (category.alwaysHighRisk) {
                html += `<div class="always-high-risk-notice">${category.highRiskReason}</div>`;
                card.classList.add('has-risk');
            } else if (category.alwaysLowRisk) {
                html += `<div class="always-low-risk-notice">This source is generally considered low risk.</div>`;
                card.classList.remove('has-risk');
            }
            
            // Generate question fields
            category.questions.forEach(q => {
                html += generateSOWField(q, index, suffix, currencySymbol);
            });
            
            questionsContainer.innerHTML = html;
            riskSection.style.display = 'none';
        }

        function generateSOWField(q, index, suffix, currencySymbol) {
            const fieldId = `sow${suffix}${index}_${q.id}`;
            const required = q.required ? '<span class="required">*</span>' : '';
            
            let html = `<div class="sow-question-group"><label class="form-label">${q.label} ${required}</label>`;
            
            switch(q.type) {
                case 'text':
                    html += `<input type="text" class="form-input" data-field-id="${q.id}" placeholder="${q.placeholder || ''}" onchange="handleSOWFieldChangeFromElement(this, '${suffix}')">`;
                    break;
                case 'number':
                    html += `<input type="number" class="form-input" data-field-id="${q.id}" placeholder="${q.placeholder || ''}" onchange="handleSOWFieldChangeFromElement(this, '${suffix}')">`;
                    break;
                case 'currency':
                    html += `<div class="currency-input" data-currency="${currencySymbol}">
                        <input type="number" class="form-input" data-field-id="${q.id}" placeholder="0" style="padding-left: 28px;" onchange="handleSOWFieldChangeFromElement(this, '${suffix}')">
                    </div>`;
                    break;
                case 'date':
                    html += `<input type="date" class="form-input" data-field-id="${q.id}" onchange="handleSOWFieldChangeFromElement(this, '${suffix}')">`;
                    break;
                case 'select':
                    html += `<select class="form-select" data-field-id="${q.id}" onchange="handleSOWFieldChangeFromElement(this, '${suffix}')"><option value="">Select...</option>`;
                    q.options.forEach(opt => html += `<option value="${opt}">${opt}</option>`);
                    html += `</select>`;
                    break;
                case 'industry':
                    html += `<select class="form-select" data-field-id="${q.id}" onchange="handleSOWFieldChangeFromElement(this, '${suffix}')"><option value="">Select industry...</option>`;
                    ALL_INDUSTRIES.forEach(ind => html += `<option value="${ind.value}">${ind.label}</option>`);
                    html += `</select><div class="industry-risk-indicator" style="display:none; color:#f59e0b; font-size:12px; margin-top:4px;">‚ö†Ô∏è Higher risk industry</div>`;
                    break;
                case 'country':
                    html += `<select class="form-select" data-field-id="${q.id}" onchange="handleSOWFieldChangeFromElement(this, '${suffix}')"><option value="">Select country...</option>`;
                    COUNTRIES_LIST.forEach(c => {
                        if (c === '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ') html += `<option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>`;
                        else {
                            const isHR = HIGHER_RISK_JURISDICTIONS.includes(c);
                            html += `<option value="${c}">${c}${isHR ? ' ‚ö†Ô∏è' : ''}</option>`;
                        }
                    });
                    html += `</select><div class="country-risk-indicator" style="display:none; color:#f59e0b; font-size:12px; margin-top:4px;">‚ö†Ô∏è Higher risk jurisdiction</div>`;
                    break;
                case 'textarea':
                    html += `<textarea class="form-textarea" data-field-id="${q.id}" placeholder="${q.placeholder || ''}" onchange="handleSOWFieldChangeFromElement(this, '${suffix}')"></textarea>`;
                    break;
                case 'multiselect':
                    html += `<div class="multiselect-group" data-field-id="${q.id}">`;
                    q.options.forEach(opt => html += `<label class="multiselect-item" onclick="toggleSOWMultiselectFromElement(this, '${suffix}')"><input type="checkbox" value="${opt}">${opt}</label>`);
                    html += `</div>`;
                    break;
            }
            
            html += `</div>`;
            return html;
        }

        function handleSOWFieldChangeFromElement(element, suffix = '') {
            const card = element.closest('.sow-category-card');
            const index = parseInt(card.getAttribute('data-sow-index'));
            const fieldId = element.getAttribute('data-field-id');
            const value = element.value;
            
            if (!sowSources[suffix][index]) {
                sowSources[suffix][index] = { type: null, data: {}, hasRisk: false };
            }
            sowSources[suffix][index].data[fieldId] = value;
            handleFieldChange(`sow${suffix}${index}_${fieldId}`, value);
            
            // Check for industry risk indicator
            if (fieldId === 'industry') {
                const isHR = HIGHER_RISK_INDUSTRIES.includes(value);
                const indicator = element.parentElement.querySelector('.industry-risk-indicator');
                if (indicator) indicator.style.display = isHR ? 'block' : 'none';
            }
            
            // Check for country risk indicator
            if (element.classList.contains('form-select') && COUNTRIES_LIST.includes(value)) {
                const isHR = HIGHER_RISK_JURISDICTIONS.includes(value);
                const indicator = element.parentElement.querySelector('.country-risk-indicator');
                if (indicator) indicator.style.display = isHR ? 'block' : 'none';
            }
            
            checkRiskTriggersForCard(card, suffix);
        }

        function toggleSOWMultiselectFromElement(element, suffix) {
            element.classList.toggle('selected');
            const checkbox = element.querySelector('input');
            checkbox.checked = !checkbox.checked;
            const container = element.parentElement;
            const selected = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);
            
            const card = element.closest('.sow-category-card');
            const index = parseInt(card.getAttribute('data-sow-index'));
            const fieldId = container.getAttribute('data-field-id');
            
            if (!sowSources[suffix][index]) {
                sowSources[suffix][index] = { type: null, data: {}, hasRisk: false };
            }
            sowSources[suffix][index].data[fieldId] = selected.join(', ');
            handleFieldChange(`sow${suffix}${index}_${fieldId}`, selected.join(', '));
            
            checkRiskTriggersForCard(card, suffix);
        }

        function checkRiskTriggersForCard(card, suffix = '') {
            const index = parseInt(card.getAttribute('data-sow-index'));
            const source = sowSources[suffix][index];
            if (!source || !source.type) return;
            
            const category = SOW_CATEGORIES[source.type];
            if (!category || category.alwaysHighRisk || category.alwaysLowRisk || !category.riskQuestions.length) return;
            
            const data = source.data;
            let hasRisk = false;
            let reasons = [];
            
            // Check jurisdictions
            Object.values(data).forEach(val => {
                if (HIGHER_RISK_JURISDICTIONS.includes(val)) {
                    hasRisk = true;
                    reasons.push(`Higher risk jurisdiction: ${val}`);
                }
            });
            
            // Check industry
            if (HIGHER_RISK_INDUSTRIES.includes(data.industry)) {
                hasRisk = true;
                reasons.push('Higher risk industry');
            }
            
            // Check PEP
            ['deceasedPEP', 'donorPEP', 'exSpousePEP'].forEach(field => {
                if (data[field] && data[field].startsWith('Yes')) {
                    hasRisk = true;
                    reasons.push('PEP connection');
                }
            });
            
            // Check senior positions
            const status = data.employmentStatus || '';
            if (['Director', 'Partner', 'Shareholder/Owner'].includes(status)) {
                hasRisk = true;
                reasons.push('Senior/influential position');
            }
            
            // Check Companies House
            if (data.companiesHouseMatch === 'No') {
                hasRisk = true;
                reasons.push('Companies House mismatch');
            }
            
            // Check commercial property
            const propType = data.propertyType || '';
            if (propType.toLowerCase().includes('commercial')) {
                hasRisk = true;
                reasons.push('Commercial property');
            }
            
            // Check insurance types
            if (['Life Insurance', 'Annuity', 'High Value Asset'].includes(data.insuranceType)) {
                hasRisk = true;
                reasons.push(`${data.insuranceType} payout`);
            }
            
            // Update UI
            const riskSection = card.querySelector('.sow-risk-section');
            source.hasRisk = hasRisk;
            
            if (hasRisk && category.riskQuestions.length) {
                card.classList.add('has-risk');
                const currencySymbol = JURISDICTION_CONFIG[currentJurisdiction].currency;
                let riskHtml = `<h4>Additional Information Required</h4>
                    <p style="font-size:12px; margin-bottom:12px; color:#78350f;">Due to: ${[...new Set(reasons)].join(', ')}</p>`;
                category.riskQuestions.forEach(q => {
                    riskHtml += generateSOWField(q, index, suffix, currencySymbol);
                });
                riskSection.innerHTML = riskHtml;
                riskSection.style.display = 'block';
            } else {
                card.classList.remove('has-risk');
                riskSection.style.display = 'none';
            }
        }

        // Initialize first SOW source on section open
        function initSOWSources() {
            if (document.getElementById('sowSourcesContainer') && getSOWSourceCount('') === 0) {
                addSOWSource('');
            }
        }

        function handleFundSourceChange(source, checked) {
            if (checked) {
                if (!selectedFundSources.includes(source)) selectedFundSources.push(source);
            } else {
                selectedFundSources = selectedFundSources.filter(s => s !== source);
            }
            handleFieldChange('fundSources', selectedFundSources.join(','));
        }

        function toggleOtherFundSource(show) {
            document.getElementById('otherFundSourceSection').classList.toggle('visible', show);
        }

        function proceedToNextForm() {
            saveProgress();
            const type = isJointApplication ? 'joint' : 'individual';
            window.location.href = `factfind_03_investment_suitability.html?type=${type}&jurisdiction=${currentJurisdiction}`;
        }

        function completeForm() {
            const masterData = JSON.parse(localStorage.getItem('evelynFactFindMaster') || '{}');
            masterData.financialProfile = { complete: true, timestamp: new Date().toISOString() };
            masterData.jurisdiction = currentJurisdiction;
            localStorage.setItem('evelynFactFindMaster', JSON.stringify(masterData));
        }
    </script>
</body>
</html>
